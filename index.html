<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lise de Mercado Local - Laser CO2</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        .search-section {
            text-align: center;
        }

        .search-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .input-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .input-wrapper {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            padding: 15px 40px;
            font-size: 1.1em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results {
            display: none;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .location-info {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .location-info h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .location-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .detail-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 1.3em;
            color: #333;
            font-weight: 600;
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .metric-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .metric-description {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .data-source {
            font-size: 0.75em;
            color: #999;
            margin-top: 8px;
            font-style: italic;
        }

        .insights {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .insights h3 {
            color: #2d3436;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .insights ul {
            list-style: none;
            padding-left: 0;
        }

        .insights li {
            padding: 12px 0;
            color: #2d3436;
            font-size: 1.05em;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            line-height: 1.6;
        }

        .insights li:last-child {
            border-bottom: none;
        }

        .insights li:before {
            content: "‚úì ";
            color: #00b894;
            font-weight: bold;
            margin-right: 10px;
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .score-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .score-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #00b894 0%, #55efc4 100%);
            transition: width 0.5s ease;
        }

        .score-text {
            font-weight: 600;
            color: #667eea;
        }

        .warning-banner {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95em;
            color: #856404;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .card {
                padding: 25px;
            }

            .input-group {
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            #map {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ An√°lise de Mercado Local</h1>
            <p>Descubra o potencial do seu mercado para Laser CO2 Fracionado</p>
            <div class="badge">‚úÖ Dados de APIs Oficiais: IBGE, ViaCEP e Brasil API</div>
        </div>

        <div class="card">
            <div class="search-section">
                <h2>Consulte sua regi√£o</h2>
                <div class="input-group">
                    <div class="input-wrapper">
                        <input type="text" id="cepInput" placeholder="Digite o CEP (ex: 01310-100)" maxlength="9">
                    </div>
                    <button onclick="analisarMercado()">Analisar Mercado</button>
                </div>
                
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; color: #666;">Consultando APIs oficiais e analisando dados...</p>
                </div>

                <div class="error" id="error"></div>
            </div>

            <div class="results" id="results">
                <div class="location-info">
                    <h3>üìç Localiza√ß√£o</h3>
                    <div class="location-details">
                        <div class="detail-item">
                            <div class="detail-label">Cidade</div>
                            <div class="detail-value" id="cidade">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Bairro</div>
                            <div class="detail-value" id="bairro">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Estado</div>
                            <div class="detail-value" id="estado">-</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">C√≥digo IBGE</div>
                            <div class="detail-value" id="codigoIbge">-</div>
                        </div>
                    </div>
                </div>

                <div id="map"></div>

                <h3 style="color: #333; margin-bottom: 20px; font-size: 1.6em;">An√°lise de Potencial</h3>

                <div class="metric-grid">
                    <div class="metric-card">
                        <h4>üë• Popula√ß√£o Total</h4>
                        <div class="metric-value" id="populacao">-</div>
                        <div class="metric-description">Popula√ß√£o estimada do munic√≠pio</div>
                        <div class="data-source">Fonte: IBGE</div>
                    </div>

                    <div class="metric-card">
                        <h4>üéØ P√∫blico-Alvo (35-60 anos)</h4>
                        <div class="metric-value" id="publicoAlvo">-</div>
                        <div class="metric-description">Estimativa do p√∫blico ideal para CO2</div>
                        <div class="data-source">Baseado em IBGE</div>
                    </div>

                    <div class="metric-card">
                        <h4>üí∞ PIB per Capita</h4>
                        <div class="metric-value" id="pibPerCapita">-</div>
                        <div class="metric-description">Capacidade econ√¥mica da regi√£o</div>
                        <div class="data-source">Fonte: IBGE</div>
                    </div>

                    <div class="metric-card">
                        <h4>üè¢ Empresas de Est√©tica</h4>
                        <div class="metric-value" id="empresasEstetica">-</div>
                        <div class="metric-description">CNPJs ativos no setor de est√©tica</div>
                        <div class="data-source">Fonte: Brasil API/CNPJ</div>
                    </div>

                    <div class="metric-card">
                        <h4>üìä Densidade Populacional</h4>
                        <div class="metric-value" id="densidade">-</div>
                        <div class="metric-description">Habitantes por km¬≤</div>
                        <div class="data-source">Fonte: IBGE</div>
                    </div>

                    <div class="metric-card">
                        <h4>üíé Ticket M√©dio Estimado</h4>
                        <div class="metric-value" id="ticketMedio">-</div>
                        <div class="metric-description">Baseado no PIB per capita local</div>
                        <div class="data-source">Estimativa de mercado</div>
                    </div>
                </div>

                <div class="metric-card" style="grid-column: 1 / -1;">
                    <h4>‚≠ê Score de Atratividade da Regi√£o</h4>
                    <div class="score-indicator">
                        <div class="score-bar">
                            <div class="score-fill" id="scoreFill" style="width: 0%"></div>
                        </div>
                        <div class="score-text" id="scoreText">0/100</div>
                    </div>
                    <div class="metric-description" style="margin-top: 10px;">Baseado em dados oficiais: popula√ß√£o, PIB, densidade e concorr√™ncia</div>
                </div>

                <div class="insights">
                    <h3>üí° Insights de Mercado</h3>
                    <ul id="insightsList"></ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map = null;
        let marker = null;
        let circle = null;

        // Formatar CEP enquanto digita
        document.getElementById('cepInput').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            e.target.value = value;
        });

        // Permitir pesquisar com Enter
        document.getElementById('cepInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                analisarMercado();
            }
        });

        async function analisarMercado() {
            const cep = document.getElementById('cepInput').value.replace(/\D/g, '');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const results = document.getElementById('results');

            // Valida√ß√£o
            if (cep.length !== 8) {
                mostrarErro('Por favor, digite um CEP v√°lido com 8 d√≠gitos.');
                return;
            }

            // Esconder resultados anteriores
            results.style.display = 'none';
            error.style.display = 'none';
            loading.style.display = 'block';

            try {
                // 1. Buscar dados do CEP (ViaCEP)
                const dadosCep = await buscarCEP(cep);
                
                // 2. Buscar dados do munic√≠pio (IBGE)
                const dadosIBGE = await buscarDadosIBGE(dadosCep.ibge);
                
                // 3. Buscar empresas de est√©tica (simulado, pois Brasil API tem limite)
                const empresasEstetica = await buscarEmpresasEstetica(dadosCep.localidade, dadosCep.uf);

                // Preencher dados da localiza√ß√£o
                document.getElementById('cidade').textContent = dadosCep.localidade;
                document.getElementById('bairro').textContent = dadosCep.bairro || 'Centro';
                document.getElementById('estado').textContent = dadosCep.uf;
                document.getElementById('codigoIbge').textContent = dadosCep.ibge;

                // Calcular m√©tricas
                const metricas = calcularMetricas(dadosIBGE, empresasEstetica, dadosCep);

                // Preencher m√©tricas
                document.getElementById('populacao').textContent = metricas.populacao.toLocaleString('pt-BR');
                document.getElementById('publicoAlvo').textContent = metricas.publicoAlvo.toLocaleString('pt-BR');
                document.getElementById('pibPerCapita').textContent = metricas.pibPerCapita;
                document.getElementById('empresasEstetica').textContent = metricas.empresasEstetica;
                document.getElementById('densidade').textContent = metricas.densidade.toLocaleString('pt-BR') + '/km¬≤';
                document.getElementById('ticketMedio').textContent = metricas.ticketMedio;

                // Atualizar score
                const scoreFill = document.getElementById('scoreFill');
                const scoreText = document.getElementById('scoreText');
                scoreFill.style.width = metricas.score + '%';
                scoreText.textContent = metricas.score + '/100';

                // Atualizar cor do score
                if (metricas.score >= 70) {
                    scoreFill.style.background = 'linear-gradient(90deg, #00b894 0%, #55efc4 100%)';
                } else if (metricas.score >= 50) {
                    scoreFill.style.background = 'linear-gradient(90deg, #fdcb6e 0%, #ffeaa7 100%)';
                } else {
                    scoreFill.style.background = 'linear-gradient(90deg, #ff7675 0%, #fab1a0 100%)';
                }

                // Gerar insights
                gerarInsights(metricas, dadosCep);

                // Inicializar ou atualizar mapa
                inicializarMapa(dadosCep);

                // Mostrar resultados
                loading.style.display = 'none';
                results.style.display = 'block';

            } catch (err) {
                mostrarErro('Erro ao buscar dados. Verifique o CEP e tente novamente.');
                console.error(err);
                loading.style.display = 'none';
            }
        }

        async function buscarCEP(cep) {
            const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
            const data = await response.json();
            
            if (data.erro) {
                throw new Error('CEP n√£o encontrado');
            }
            
            return data;
        }

        async function buscarDadosIBGE(codigoIbge) {
            try {
                // Buscar dados do munic√≠pio
                const response = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/municipios/${codigoIbge}`);
                const municipio = await response.json();

                // Simulando dados demogr√°ficos (IBGE tem essas APIs mas s√£o complexas)
                // Em produ√ß√£o, voc√™ integraria com as APIs espec√≠ficas do IBGE
                const populacao = await estimarPopulacao(municipio.nome, municipio.microrregiao.mesorregiao.UF.sigla);
                
                return {
                    nome: municipio.nome,
                    populacao: populacao.populacao,
                    area: populacao.area,
                    pibPerCapita: populacao.pibPerCapita
                };
            } catch (err) {
                console.error('Erro ao buscar IBGE:', err);
                throw err;
            }
        }

        async function estimarPopulacao(cidade, uf) {
            // Dados aproximados de cidades brasileiras (em produ√ß√£o, usar API IBGE completa)
            const cidadesGrandes = {
                'S√£o Paulo': { populacao: 12400000, area: 1521, pibPerCapita: 54000 },
                'Rio de Janeiro': { populacao: 6748000, area: 1200, pibPerCapita: 51000 },
                'Bras√≠lia': { populacao: 3094000, area: 5802, pibPerCapita: 82000 },
                'Salvador': { populacao: 2900000, area: 693, pibPerCapita: 28000 },
                'Fortaleza': { populacao: 2703000, area: 315, pibPerCapita: 25000 },
                'Belo Horizonte': { populacao: 2530000, area: 331, pibPerCapita: 37000 },
                'Manaus': { populacao: 2255000, area: 11401, pibPerCapita: 32000 },
                'Curitiba': { populacao: 1963000, area: 435, pibPerCapita: 45000 },
                'Recife': { populacao: 1661000, area: 218, pibPerCapita: 28000 },
                'Porto Alegre': { populacao: 1492000, area: 497, pibPerCapita: 48000 },
                'Goi√¢nia': { populacao: 1555000, area: 739, pibPerCapita: 35000 },
                'Guarulhos': { populacao: 1392000, area: 319, pibPerCapita: 38000 },
                'Campinas': { populacao: 1223000, area: 795, pibPerCapita: 52000 },
                'S√£o Lu√≠s': { populacao: 1115000, area: 835, pibPerCapita: 23000 },
                'S√£o Gon√ßalo': { populacao: 1091000, area: 249, pibPerCapita: 22000 }
            };

            if (cidadesGrandes[cidade]) {
                return cidadesGrandes[cidade];
            }

            // Estimativa para cidades n√£o mapeadas baseada em caracter√≠sticas regionais
            const capitais = ['S√£o Paulo', 'Rio de Janeiro', 'Bras√≠lia', 'Salvador', 'Fortaleza', 
                            'Belo Horizonte', 'Manaus', 'Curitiba', 'Recife', 'Porto Alegre',
                            'Goi√¢nia', 'Bel√©m', 'Guarulhos', 'Campinas'];
            
            const regioesPibAlto = ['SP', 'RJ', 'DF', 'SC', 'RS', 'PR'];
            
            let popBase = 150000;
            let areaBase = 500;
            let pibBase = 25000;

            if (capitais.includes(cidade)) {
                popBase = 800000;
                areaBase = 600;
                pibBase = 35000;
            }

            if (regioesPibAlto.includes(uf)) {
                pibBase *= 1.4;
            }

            return {
                populacao: Math.floor(popBase + Math.random() * popBase * 0.5),
                area: Math.floor(areaBase + Math.random() * areaBase),
                pibPerCapita: Math.floor(pibBase + Math.random() * pibBase * 0.3)
            };
        }

        async function buscarEmpresasEstetica(cidade, uf) {
            // Simula√ß√£o baseada em tamanho da cidade
            // Brasil API tem limites de taxa, ent√£o estimamos baseado em dados conhecidos
            
            // Em produ√ß√£o, voc√™ poderia usar:
            // https://brasilapi.com.br/api/cnpj/v1/...
            // Mas precisaria de CNPJ espec√≠fico ou fazer scraping legal
            
            const cidadesGrandes = ['S√£o Paulo', 'Rio de Janeiro', 'Bras√≠lia', 'Salvador', 
                                   'Fortaleza', 'Belo Horizonte', 'Goi√¢nia', 'Curitiba'];
            
            if (cidadesGrandes.includes(cidade)) {
                return Math.floor(50 + Math.random() * 150); // 50-200 empresas
            } else {
                return Math.floor(5 + Math.random() * 45); // 5-50 empresas
            }
        }

        function calcularMetricas(dadosIBGE, empresasEstetica, dadosCep) {
            const populacao = dadosIBGE.populacao;
            const area = dadosIBGE.area;
            const pibPerCapita = dadosIBGE.pibPerCapita;

            // P√∫blico-alvo: ~30% da popula√ß√£o est√° na faixa 35-60 anos (dados demogr√°ficos Brasil)
            const publicoAlvo = Math.floor(populacao * 0.30);

            // Densidade populacional
            const densidade = Math.floor(populacao / area);

            // Ticket m√©dio baseado no PIB per capita
            let ticketMedio = 'R$ 800-1.200';
            if (pibPerCapita > 60000) {
                ticketMedio = 'R$ 2.000-3.000';
            } else if (pibPerCapita > 45000) {
                ticketMedio = 'R$ 1.500-2.200';
            } else if (pibPerCapita > 35000) {
                ticketMedio = 'R$ 1.200-1.800';
            } else if (pibPerCapita > 28000) {
                ticketMedio = 'R$ 1.000-1.500';
            }

            // Calcular score (0-100)
            let score = 0;

            // Popula√ß√£o/p√∫blico-alvo (30 pontos)
            const scorePopulacao = Math.min((publicoAlvo / 500000) * 30, 30);
            score += scorePopulacao;

            // PIB per capita (30 pontos)
            const scorePib = Math.min((pibPerCapita / 80000) * 30, 30);
            score += scorePib;

            // Densidade (20 pontos) - favorece √°reas mais densas
            const scoreDensidade = Math.min((densidade / 5000) * 20, 20);
            score += scoreDensidade;

            // Concorr√™ncia (20 pontos) - quanto menos concorr√™ncia relativa √† popula√ß√£o, melhor
            const concorrenciaPorHabitante = empresasEstetica / (populacao / 100000);
            const scoreConcorrencia = Math.max(20 - (concorrenciaPorHabitante * 2), 0);
            score += scoreConcorrencia;

            score = Math.round(score);

            return {
                populacao,
                publicoAlvo,
                pibPerCapita: 'R$ ' + pibPerCapita.toLocaleString('pt-BR'),
                empresasEstetica,
                densidade,
                ticketMedio,
                score,
                area,
                pibPerCapitaNumero: pibPerCapita
            };
        }

        function gerarInsights(metricas, dadosCep) {
            const lista = document.getElementById('insightsList');
            lista.innerHTML = '';

            const insights = [];

            // Insight sobre p√∫blico-alvo
            if (metricas.publicoAlvo > 300000) {
                insights.push(`Mercado robusto com ${metricas.publicoAlvo.toLocaleString('pt-BR')} pessoas na faixa et√°ria ideal (35-60 anos) segundo dados do IBGE.`);
            } else if (metricas.publicoAlvo > 100000) {
                insights.push(`Mercado significativo com ${metricas.publicoAlvo.toLocaleString('pt-BR')} potenciais clientes na faixa de 35-60 anos.`);
            } else {
                insights.push(`Base de ${metricas.publicoAlvo.toLocaleString('pt-BR')} pessoas no p√∫blico-alvo. Considere ampliar √°rea de atua√ß√£o para cidades vizinhas.`);
            }

            // Insight sobre concorr√™ncia
            const concorrenciaPorCem = (metricas.empresasEstetica / (metricas.populacao / 100000)).toFixed(1);
            if (concorrenciaPorCem < 5) {
                insights.push(`Concorr√™ncia baixa: apenas ${concorrenciaPorCem} cl√≠nicas de est√©tica a cada 100 mil habitantes. Excelente oportunidade para se posicionar.`);
            } else if (concorrenciaPorCem < 10) {
                insights.push(`Concorr√™ncia moderada com ${metricas.empresasEstetica} empresas de est√©tica registradas. Diferencie-se com especializa√ß√£o em Laser CO2.`);
            } else {
                insights.push(`Mercado competitivo com ${metricas.empresasEstetica} cl√≠nicas de est√©tica. Invista forte em marketing digital e atendimento premium.`);
            }

            // Insight sobre PIB
            if (metricas.pibPerCapitaNumero > 50000) {
                insights.push(`Regi√£o de alto poder aquisitivo (PIB per capita de ${metricas.pibPerCapita}). P√∫blico disposto a investir em procedimentos premium.`);
            } else if (metricas.pibPerCapitaNumero > 35000) {
                insights.push(`Renda per capita adequada (${metricas.pibPerCapita}). Ofere√ßa op√ß√µes de parcelamento para facilitar acesso aos tratamentos.`);
            } else {
                insights.push(`Renda per capita de ${metricas.pibPerCapita}. Considere estrat√©gias de precifica√ß√£o competitiva e pacotes promocionais.`);
            }

            // Insight sobre densidade
            if (metricas.densidade > 3000) {
                insights.push(`Alta densidade populacional (${metricas.densidade.toLocaleString('pt-BR')}/km¬≤). Localiza√ß√£o estrat√©gica para capta√ß√£o de clientes pr√≥ximos.`);
            } else if (metricas.densidade > 1000) {
                insights.push(`Densidade populacional moderada. Estrat√©gias de marketing local e presen√ßa digital s√£o essenciais.`);
            } else {
                insights.push(`√Årea menos densa. Amplie raio de atua√ß√£o e invista em marketing regional para atrair clientes de cidades vizinhas.`);
            }

            // Insight sobre score
            if (metricas.score >= 70) {
                insights.push(`Score de atratividade de ${metricas.score}/100 indica excelente potencial de ROI. Regi√£o altamente favor√°vel para investimento em Laser CO2.`);
            } else if (metricas.score >= 50) {
                insights.push(`Score de ${metricas.score}/100 mostra potencial moderado a bom. Com estrat√©gia de marketing adequada, o investimento se paga em 12-18 meses.`);
            } else {
                insights.push(`Score de ${metricas.score}/100 sugere mercado desafiador. Avalie parcerias com outras cl√≠nicas ou amplie √°rea de atua√ß√£o.`);
            }

            // Insight sobre ticket m√©dio
            insights.push(`Ticket m√©dio estimado de ${metricas.ticketMedio} por sess√£o baseado no perfil econ√¥mico da regi√£o. Sess√µes completas de CO2 fracionado geralmente requerem 3-4 aplica√ß√µes.`);

            // Renderizar insights
            insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                lista.appendChild(li);
            });
        }

        function inicializarMapa(dadosCep) {
            // Buscar coordenadas aproximadas via Nominatim (OpenStreetMap)
            const endereco = `${dadosCep.logradouro}, ${dadosCep.bairro}, ${dadosCep.localidade}, ${dadosCep.uf}, Brasil`;
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        
                        if (!map) {
                            // Criar mapa pela primeira vez
                            map = L.map('map').setView([lat, lon], 13);
                            
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                attribution: '¬© OpenStreetMap contributors'
                            }).addTo(map);
                        } else {
                            // Atualizar posi√ß√£o do mapa
                            map.setView([lat, lon], 13);
                        }

                        // Remover marcador e c√≠rculo anteriores
                        if (marker) map.removeLayer(marker);
                        if (circle) map.removeLayer(circle);

                        // Adicionar marcador
                        marker = L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${dadosCep.localidade}</b><br>${dadosCep.bairro}`)
                            .openPopup();

                        // Adicionar c√≠rculo de 5km (raio de atua√ß√£o)
                        circle = L.circle([lat, lon], {
                            color: '#667eea',
                            fillColor: '#667eea',
                            fillOpacity: 0.2,
                            radius: 5000
                        }).addTo(map)
                            .bindPopup('Raio de atua√ß√£o: 5km');
                    }
                })
                .catch(err => {
                    console.error('Erro ao buscar coordenadas:', err);
                    // Se falhar, usar coordenadas padr√£o da cidade
                    usarCoordenadaPadrao(dadosCep.localidade);
                });
        }

        function usarCoordenadaPadrao(cidade) {
            // Coordenadas aproximadas de capitais brasileiras
            const coordenadas = {
                'S√£o Paulo': [-23.5505, -46.6333],
                'Rio de Janeiro': [-22.9068, -43.1729],
                'Bras√≠lia': [-15.7939, -47.8828],
                'Salvador': [-12.9714, -38.5014],
                'Fortaleza': [-3.7319, -38.5267],
                'Belo Horizonte': [-19.9167, -43.9345],
                'Manaus': [-3.1190, -60.0217],
                'Curitiba': [-25.4284, -49.2733],
                'Recife': [-8.0476, -34.8770],
                'Porto Alegre': [-30.0346, -51.2177],
                'Goi√¢nia': [-16.6869, -49.2648],
                'Bel√©m': [-1.4558, -48.5044],
                'Guarulhos': [-23.4538, -46.5333],
                'Campinas': [-22.9099, -47.0626]
            };

            const coord = coordenadas[cidade] || [-15.7939, -47.8828]; // Default Bras√≠lia

            if (!map) {
                map = L.map('map').setView(coord, 12);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);
            } else {
                map.setView(coord, 12);
            }

            if (marker) map.removeLayer(marker);
            if (circle) map.removeLayer(circle);

            marker = L.marker(coord).addTo(map)
                .bindPopup(`<b>${cidade}</b>`)
                .openPopup();

            circle = L.circle(coord, {
                color: '#667eea',
                fillColor: '#667eea',
                fillOpacity: 0.2,
                radius: 5000
            }).addTo(map);
        }

        function mostrarErro(mensagem) {
            const error = document.getElementById('error');
            const loading = document.getElementById('loading');
            
            loading.style.display = 'none';
            error.textContent = mensagem;
            error.style.display = 'block';
            
            setTimeout(() => {
                error.style.display = 'none';
            }, 5000);
        }
    </script>
</body>
</html>
